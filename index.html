<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Flask Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added crossorigin attribute to help with some browser tracking prevention warnings -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .message-bubble { animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-dot { animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .modal-fade { animation: fadeInModal 0.2s ease-out forwards; }
        @keyframes fadeInModal {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-center bg-no-repeat bg-fixed relative">
    
    <div class="absolute inset-0 bg-black/70 z-0"></div>

    <div class="w-full max-w-4xl h-[85vh] glass-panel rounded-2xl shadow-2xl flex flex-col relative z-10 overflow-hidden">
        
        <!-- Header -->
        <div class="bg-gray-800/80 p-4 border-b border-gray-700 flex flex-wrap gap-4 justify-between items-center backdrop-blur-md">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center shadow-lg shrink-0">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide leading-tight">Gemini Flask Integration</h1>
                    <p class="text-xs text-gray-400">Powered by Google GenAI</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3 shrink-0 ml-auto sm:ml-0">
                <button onclick="toggleModal(true)" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-full transition-colors border border-gray-600 whitespace-nowrap">
                    <i class="fas fa-question-circle mr-1"></i> Help
                </button>
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-900/50 border border-gray-700 whitespace-nowrap">
                    <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500 animate-pulse"></span>
                    <span id="status-text" class="text-xs font-mono text-gray-400 uppercase tracking-wider">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="flex gap-4 message-bubble">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex-shrink-0 flex items-center justify-center text-xs">AI</div>
                <div class="flex flex-col gap-1 max-w-[80%]">
                    <div class="bg-gray-800/80 p-4 rounded-2xl rounded-tl-none border border-gray-700 shadow-md">
                        <p class="text-sm text-gray-200 leading-relaxed">
                            Hello! I am ready to chat. <br>
                            If you see "Disconnected" above, check the <button onclick="toggleModal(true)" class="text-blue-400 hover:underline">Help</button> menu for the "Static Folder" fix.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden px-6 pb-4">
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex-shrink-0 flex items-center justify-center text-xs">AI</div>
                <div class="bg-gray-800/50 p-3 rounded-2xl rounded-tl-none border border-gray-700 w-16 flex items-center justify-center gap-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-gray-800/80 border-t border-gray-700 backdrop-blur-md">
            <form id="chat-form" class="flex gap-3 relative">
                <input type="text" id="user-input" class="w-full bg-gray-900/50 border border-gray-600 text-gray-100 rounded-xl px-5 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500 transition-all" placeholder="Ask a question..." autocomplete="off">
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white rounded-xl px-6 py-3 font-semibold shadow-lg shadow-blue-600/20 transition-all active:scale-95 flex items-center gap-2">
                    <span>Send</span> <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </form>
            <p id="target-url-display" class="text-center text-[10px] text-gray-500 mt-3 font-mono"></p>
        </div>
    </div>

    <!-- Troubleshooting Modal -->
    <div id="help-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-gray-800 border border-gray-600 rounded-2xl max-w-md w-full p-6 shadow-2xl modal-fade">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-white"><i class="fas fa-folder-open text-yellow-500 mr-2"></i>Setup Guide</h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="modal-content" class="space-y-4 text-sm text-gray-300">
                <!-- Content will be injected by JS based on detection -->
            </div>

            <button onclick="toggleModal(false)" class="w-full mt-6 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 rounded-xl transition-colors">
                Close
            </button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const helpModal = document.getElementById('help-modal');
        const modalContent = document.getElementById('modal-content');
        const targetUrlDisplay = document.getElementById('target-url-display');

        // SMART URL DETECTION
        // If opened as a file (file://), we assume localhost:5000 (requires CORS ext).
        // If opened via Live Server (port 5500), we assume localhost:5000 (requires CORS ext).
        // If served by Flask (port 5000), we use relative path (Works natively!).
        const isLocalFile = window.location.protocol === 'file:';
        const port = window.location.port;
        const isLiveServer = port === '5500'; 
        
        // Point to Flask (5000) if we are on File or Live Server. Otherwise relative.
        const API_BASE_URL = (isLocalFile || isLiveServer) ? 'http://127.0.0.1:5000' : '';

        // UI Feedback about connection mode
        if (isLocalFile) {
            targetUrlDisplay.innerHTML = `<span class="text-red-400">Mode: Local File (CORS Error Expected)</span>`;
            updateModalContent('file');
        } else if (isLiveServer) {
            targetUrlDisplay.innerHTML = `<span class="text-orange-400">Warning: Using Live Server (Port 5500).</span>`;
            updateModalContent('live-server');
            setTimeout(() => toggleModal(true), 500); // Auto open modal for Live Server users
        } else {
            targetUrlDisplay.innerHTML = `<span class="text-green-400">Mode: Flask Hosted (Correct)</span>`;
            updateModalContent('success');
        }

        function updateModalContent(mode) {
            if (mode === 'live-server' || mode === 'file') {
                modalContent.innerHTML = `
                <div class="bg-red-900/30 p-3 rounded-lg border border-red-800">
                    <p class="font-semibold text-red-200 mb-1">CORS Error Detected!</p>
                    <p>You are running this on Port 5500 or as a file. The backend is on Port 5000. Browsers block this connection.</p>
                </div>
                <div class="space-y-2 mt-4">
                    <p class="font-bold text-white">How to fix (30 seconds):</p>
                    <div class="flex gap-3 items-start">
                        <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-xs mt-0.5">1</div>
                        <div><span class="text-white">Create Folder:</span> Create a folder named <code>static</code> inside your Python project.</div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-xs mt-0.5">2</div>
                        <div><span class="text-white">Move File:</span> Move this <code>index.html</code> file inside that <code>static</code> folder.</div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-xs mt-0.5">3</div>
                        <div>
                            <span class="text-white">Use Correct Link:</span><br>
                            <a href="http://127.0.0.1:5000/static/index.html" class="text-blue-400 underline font-bold text-lg">Click here to open correctly</a>
                        </div>
                    </div>
                </div>`;
            } else {
                modalContent.innerHTML = `
                <div class="bg-green-900/30 p-3 rounded-lg border border-green-800">
                    <p class="font-semibold text-green-200 mb-1">Setup looks good!</p>
                    <p>You are connected to the Flask backend correctly.</p>
                </div>
                <p class="mt-2">If you still have issues, check your Python console for "500 Internal Server Errors".</p>
                `;
            }
        }

        function toggleModal(show) {
            helpModal.classList.toggle('hidden', !show);
        }

        async function checkBackendHealth() {
            updateStatus('checking');
            try {
                // If served from Flask, this works perfectly.
                const response = await fetch(`${API_BASE_URL}/`);
                if (response.ok) {
                    updateStatus('online');
                } else {
                    updateStatus('error');
                }
            } catch (error) {
                console.error("Health check failed:", error);
                updateStatus('offline');
                
                // If we are in file:// mode and fail, assume it's the CORS issue
                if (isLocalFile || isLiveServer) {
                   setTimeout(() => toggleModal(true), 1500);
                }
            }
        }

        function updateStatus(state) {
            statusDot.className = 'w-2.5 h-2.5 rounded-full transition-colors duration-300';
            if (state === 'online') {
                statusDot.classList.add('bg-green-500');
                statusText.textContent = 'SYSTEM ONLINE';
                statusText.className = 'text-xs font-mono text-green-400 uppercase tracking-wider';
            } else if (state === 'offline') {
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'DISCONNECTED';
                statusText.className = 'text-xs font-mono text-red-400 uppercase tracking-wider cursor-pointer';
                statusText.onclick = () => toggleModal(true);
            } else {
                statusDot.classList.add('bg-yellow-500', 'animate-pulse');
                statusText.textContent = 'CHECKING...';
                statusText.className = 'text-xs font-mono text-yellow-500 uppercase tracking-wider';
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage(message, 'user');
            userInput.value = '';
            showTyping(true);

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }) 
                });

                if (!response.ok) {
                    // It connected, but the server returned an error (e.g., 500 Internal Server Error)
                    const errorText = await response.text();
                    // We throw a clear error here to be caught below
                    throw new Error(`Server Error ${response.status}: ${errorText || response.statusText}`);
                }

                const botReply = await response.text();
                appendMessage(botReply, 'bot');
            } catch (error) {
                console.error(error);
                let errorMessage = '';

                // Distinguish between Connection Error (CORS/Offline) and Server Error (Python Crash)
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    toggleModal(true); // Only open helper for connection issues
                    errorMessage = 'Connection failed. Browser blocked the request. Please check the Help menu for "Static Folder" setup.';
                } else {
                    // This is a backend error (e.g., API key issue)
                    errorMessage = `Backend Error: ${error.message}. Check your Python console logs for details.`;
                }
                
                appendMessage(errorMessage, 'error');
            } finally {
                showTyping(false);
            }
        });

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex gap-4 message-bubble ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const bubbleStyle = sender === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 
                              (sender === 'error' ? 'bg-red-900/50 border border-red-700 text-red-200' : 'bg-gray-800/80 text-gray-200 border border-gray-700 rounded-tl-none');
            
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full ${sender === 'user' ? 'bg-gray-600' : 'bg-gradient-to-tr from-blue-500 to-purple-600'} flex-shrink-0 flex items-center justify-center text-white shadow-lg">
                    ${sender === 'user' ? '<i class="fas fa-user text-xs"></i>' : 'AI'}
                </div>
                <div class="flex flex-col gap-1 max-w-[80%]">
                    <div class="${bubbleStyle} p-4 rounded-2xl shadow-md text-sm leading-relaxed">${text}</div>
                    ${sender !== 'error' ? `<span class="text-[10px] text-gray-500 ${sender === 'user' ? 'text-right' : 'text-left'}">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>` : ''}
                </div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping(show) {
            typingIndicator.classList.toggle('hidden', !show);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        checkBackendHealth();
    </script>
</body>
</html>